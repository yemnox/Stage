<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord de surveillance des équipements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Update user info from session
        document.addEventListener('DOMContentLoaded', function() {
            // Get user info from template variables
            const userName = '{{ user_name }}' || 'Utilisateur';
            const userEmail = '{{ user_email }}' || 'user@example.com';
            
            // Update UI with user info
            document.getElementById('userName').textContent = userName;
            document.getElementById('userInitials').textContent = userName.charAt(0).toUpperCase();
            
            // Update time every second
            function updateTime() {
                const now = new Date();
                document.getElementById('current-time').textContent = now.toLocaleTimeString('fr-FR');
            }
            updateTime();
            setInterval(updateTime, 1000);
            
            // Handle dropdown menu
            const dropdownButton = document.querySelector('.group');
            const dropdownMenu = document.querySelector('.group .hidden');
            
            // Toggle dropdown on button click
            dropdownButton.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownMenu.classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!dropdownButton.contains(e.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });
            
            // Prevent dropdown from closing when clicking inside it
            dropdownMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Set up logout function
            window.logout = async function() {
                try {
                    const response = await fetch('/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    // Always redirect to home page, regardless of response
                    window.location.href = '/';
                } catch (error) {
                    console.error('Logout failed:', error);
                    window.location.href = '/';
                }
            };
        });
        
        async function logout() {
            try {
                const response = await fetch('/logout', { 
                    method: 'POST',
                    credentials: 'same-origin' // Important for sending cookies
                });
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error during logout:', error);
                window.location.href = '/login';
            }
        }
        
        function initializeDashboard() {
            // Any dashboard initialization code can go here
            console.log('Dashboard initialized');
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
        }
        .bg-gradient {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-700) 100%);
        }
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .status-online {
            background-color: #dcfce7;
            color: #166534;
        }
        .status-issue {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-3xl font-bold text-gray-900">
                    Tableau de bord
                </h1>
                {% if current_user and (current_user.role == 'admin' or 'MANAGE_USERS' in (current_user.permissions or [])) %}
                <a href="/admin/dashboard" class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    Admin Dashboard
                </a>
                {% endif %}
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative group" style="cursor: pointer;">
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-semibold" id="userInitials">
                            U
                        </div>
                        <span class="text-gray-700 font-medium" id="userName">Utilisateur</span>
                        <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
                    </div>
                    <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 hidden">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" onclick="event.preventDefault(); logout();">
                            <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
                        </a>
                    </div>
                </div>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                    <span class="w-2 h-2 mr-2 rounded-full bg-blue-500"></span>
                    <span id="connection-status">Connecté</span>
                </span>
                <span id="current-time" class="text-gray-600"></span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-4 text-gray-700">Chargement du tableau de bord...</p>
            </div>
        </div>
        
        <!-- Error Container -->
        <div id="error-container" class="mb-6" style="display: none;"></div>
        <!-- Top Bar -->
        <div class="flex flex-col md:flex-row gap-6 mb-8">
            <!-- Filters -->
            <div class="flex-1 bg-white rounded-lg shadow p-6">
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <label for="ligne" class="block text-sm font-medium text-gray-700 mb-2">Ligne</label>
                        <select id="ligne" name="ligne" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                onchange="this.form.submit()">
                            <option value="">Toutes les lignes</option>
                            {% for ligne in lignes %}
                            <option value="{{ ligne.value }}" {% if ligne.value == selected_ligne %}selected{% endif %}>
                                {{ ligne.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="atelier" class="block text-sm font-medium text-gray-700 mb-2">Atelier</label>
                        <select id="atelier" name="atelier" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                onchange="this.form.submit()">
                            <option value="">Tous les ateliers</option>
                            {% if selected_ligne %}
                                {% for atelier in ateliers[selected_ligne] %}
                                <option value="{{ atelier.value }}" {% if atelier.value == selected_atelier %}selected{% endif %}>
                                    {{ atelier.label }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="flex-1 flex space-x-4">
                <!-- Total Equipment -->
                <div class="flex-1 bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-server text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-sm font-medium text-gray-500">Équipements</h3>
                            <p id="total-equipment" class="text-3xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Online -->
                <div class="flex-1 bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-check-circle text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-sm font-medium text-gray-500">En ligne</h3>
                            <p id="online-equipment" class="text-3xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Issues -->
                <div class="flex-1 bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-red-100 text-red-600">
                            <i class="fas fa-exclamation-circle text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-sm font-medium text-gray-500">Problèmes</h3>
                            <p id="issues-equipment" class="text-3xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Equipment List -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow overflow-hidden h-full flex flex-col">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-medium text-gray-900">Liste des équipements</h2>
                        <p class="mt-1 text-sm text-gray-500"><span id="equipment-count">0 équipements</span></p>
                    </div>
                    <div class="overflow-hidden flex flex-col" style="height: 300px;">
                        <div class="divide-y divide-gray-200 overflow-y-auto flex-1" id="equipment-list">
                            <!-- Equipment items will be populated by JavaScript -->
                            <div class="p-4 text-center text-gray-500">
                                <p>Chargement des équipements...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Rate Chart -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-medium text-gray-900 mb-4">Historique du débit de données</h2>
                        <select id="equipment-selector" class="mt-1 block w-1/3 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">Sélectionner un équipement</option>
                            <!-- Options will be added by JavaScript -->
                        </select>
                    </div>
                    <div class="h-80">
                        <canvas id="dataRateChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let dataRateChart;
        let currentEquipmentId = null;
        let allEquipment = [];
        let updateInterval;
        let isConnected = true;
        let deviceStatus = {}; // Store device status

        // Update atelier dropdown based on selected ligne
        function updateAtelierDropdown(selectedLigne, selectedAtelier = '') {
            const atelierSelect = document.getElementById('atelier');
            if (!atelierSelect) return;
            
            // Clear existing options
            atelierSelect.innerHTML = '';
            
            // Add empty option
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Tous les ateliers';
            atelierSelect.appendChild(emptyOption);
            
            // Add atelier options if a ligne is selected
            if (selectedLigne && availableFilters.ateliers[selectedLigne]) {
                availableFilters.ateliers[selectedLigne].forEach(atelier => {
                    const option = document.createElement('option');
                    option.value = atelier.value;
                    option.textContent = atelier.label;
                    if (atelier.value === selectedAtelier) {
                        option.selected = true;
                    }
                    atelierSelect.appendChild(option);
                });
            }
        }
        
        // Fetch and populate filter options
        async function fetchFilters() {
            try {
                const response = await fetch('/api/filters');
                if (!response.ok) throw new Error('Failed to fetch filters');
                
                const data = await response.json();
                availableFilters = data;
                
                // Get URL parameters for selected filters
                const urlParams = new URLSearchParams(window.location.search);
                const selectedLigne = urlParams.get('selected_ligne') || '';
                const selectedAtelier = urlParams.get('selected_atelier') || '';
                
                // Populate ligne dropdown
                const ligneSelect = document.getElementById('ligne');
                if (ligneSelect) {
                    // Clear existing options
                    ligneSelect.innerHTML = '';
                    
                    // Add empty option
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'Toutes les lignes';
                    ligneSelect.appendChild(emptyOption);
                    
                    // Add ligne options
                    availableFilters.lignes.forEach(ligne => {
                        const option = document.createElement('option');
                        option.value = ligne.value;
                        option.textContent = ligne.label;
                        if (ligne.value === selectedLigne) {
                            option.selected = true;
                        }
                        ligneSelect.appendChild(option);
                    });
                    
                    // Add event listener for ligne change
                    ligneSelect.addEventListener('change', (e) => {
                        const selectedLigne = e.target.value;
                        updateAtelierDropdown(selectedLigne);
                        filterEquipmentList(selectedLigne, '');
                    });
                }
                
                // Initialize atelier dropdown
                updateAtelierDropdown(selectedLigne, selectedAtelier);
                
                // Add event listener for atelier change
                const atelierSelect = document.getElementById('atelier');
                if (atelierSelect) {
                    atelierSelect.addEventListener('change', (e) => {
                        const selectedAtelier = e.target.value;
                        filterEquipmentList(
                            document.getElementById('ligne')?.value || '',
                            selectedAtelier
                        );
                    });
                }
                
                // Apply initial filters
                filterEquipmentList(selectedLigne, selectedAtelier);
                
                return true;
                
            } catch (error) {
                console.error('Error fetching filters:', error);
                return false;
            }
        }
        
        // Filter equipment list based on selected filters
        function filterEquipmentList(ligne, atelier) {
            console.log('Filtering equipment list with:', { ligne, atelier });
            
            // Update URL with filter parameters without page reload
            const url = new URL(window.location);
            if (ligne) {
                url.searchParams.set('ligne', ligne);
            } else {
                url.searchParams.delete('ligne');
            }
            
            if (atelier) {
                url.searchParams.set('atelier', atelier);
            } else {
                url.searchParams.delete('atelier');
            }
            
            window.history.pushState({}, '', url);
            
            // Update the equipment list display
            const equipmentList = document.getElementById('equipment-list');
            if (!equipmentList) return;
            
            const equipmentItems = equipmentList.querySelectorAll('.equipment-item');
            let visibleCount = 0;
            
            equipmentItems.forEach(item => {
                const itemLigne = item.getAttribute('data-ligne');
                const itemAtelier = item.getAttribute('data-atelier');
                
                const matchesLigne = !ligne || itemLigne === ligne;
                const matchesAtelier = !atelier || itemAtelier === atelier;
                
                if (matchesLigne && matchesAtelier) {
                    item.style.display = 'flex';
                    visibleCount++;
                    
                    // If this is the first visible item and no equipment is selected, select it
                    if (visibleCount === 1 && !currentEquipmentId) {
                        currentEquipmentId = parseInt(item.getAttribute('data-id'));
                        item.classList.add('bg-blue-50', 'border-l-4', 'border-blue-500');
                        updateChart();
                    }
                } else {
                    item.style.display = 'none';
                    item.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
                }
            });
            
            // Update the equipment count
            updateEquipmentCount(visibleCount);
            
            // Update dashboard stats with current filters
            fetchEquipmentData().then(data => {
                if (data && Array.isArray(data)) {
                    updateDashboardStats(data);
                }
            });
            
            // If no equipment is selected but there are visible items, select the first one
            if (visibleCount > 0 && !document.querySelector('.equipment-item.bg-blue-50')) {
                const firstVisible = equipmentList.querySelector('.equipment-item[style*="display: flex"]');
                if (firstVisible) {
                    currentEquipmentId = parseInt(firstVisible.getAttribute('data-id'));
                    firstVisible.classList.add('bg-blue-50', 'border-l-4', 'border-blue-500');
                    updateChart();
                }
            }
        }
        
        // Show loading state
        function showLoading(show) {
            const loadingElement = document.getElementById('loading-indicator');
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI elements
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Show loading indicator
            showLoading(true);
            
            // Initialize filters and fetch initial data
            const initDashboard = async () => {
                try {
                    // First, load filters
                    await fetchFilters();
                    
                    // Then load device status and equipment data in parallel
                    const [statusData, equipmentData] = await Promise.all([
                        fetchDeviceStatus(),
                        fetchEquipmentData()
                    ]);
                    
                    console.log('Dashboard initialized:', {
                        devices: statusData.length,
                        equipment: equipmentData.length
                    });
                    
                    // Set up auto-refresh every 5 seconds
                    updateInterval = setInterval(async () => {
                        try {
                            await fetchDeviceStatus();
                            await fetchEquipmentData();
                        } catch (error) {
                            console.error('Error during auto-refresh:', error);
                        }
                    }, 5000);
                    
                } catch (error) {
                    console.error('Error initializing dashboard:', error);
                    // Show error message to user
                    const errorContainer = document.getElementById('error-container');
                    if (errorContainer) {
                        errorContainer.innerHTML = `
                            <div class="bg-red-50 border-l-4 border-red-500 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-circle text-red-600"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-red-700">
                                            Erreur de chargement des données. Vérifiez votre connexion et rafraîchissez la page.
                                            <br>
                                            <small>${error.message || 'Erreur inconnue'}</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                        errorContainer.style.display = 'block';
                    }
                } finally {
                    // Hide loading indicator
                    showLoading(false);
                }
            };
            
            // Start initialization
            initDashboard();
        });

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
        }

        // Update connection status
        function updateConnectionStatus(isConnected) {
            const statusElement = document.getElementById('connection-status');
            if (isConnected) {
                statusElement.textContent = 'Connecté';
                statusElement.classList.remove('bg-red-100', 'text-red-800');
                statusElement.classList.add('bg-green-100', 'text-green-800');
            } else {
                statusElement.textContent = 'Déconnecté';
                statusElement.classList.remove('bg-green-100', 'text-green-800');
                statusElement.classList.add('bg-red-100', 'text-red-800');
            }
        }

        // Fetch equipment data from the API
        async function fetchEquipmentData() {
            try {
                const response = await fetch('/api/equipment');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                
                // Merge device status with equipment data
                const mergedData = data.map(equip => {
                    const status = deviceStatus[equip.name] || 'offline';
                    return {
                        ...equip,
                        status: status,
                        last_checked: new Date().toISOString()
                    };
                });
                
                allEquipment = mergedData;
                updateEquipmentList(mergedData);
                updateDashboardStats(mergedData);
                
                // If no equipment is selected, select the first one
                if (mergedData.length > 0 && !currentEquipmentId) {
                    currentEquipmentId = mergedData[0].id;
                    updateChart();
                }
                
                updateConnectionStatus(true);
                return mergedData;
            } catch (error) {
                console.error('Error fetching equipment data:', error);
                updateConnectionStatus(false);
                return [];
            }
        }
        
        // Fetch device status from the monitoring system
        async function fetchDeviceStatus() {
            try {
                const startTime = performance.now();
                const response = await fetch('/api/devices/status', {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const statusData = await response.json();
                const endTime = performance.now();
                console.log(`Fetched device status in ${(endTime - startTime).toFixed(2)}ms`);
                
                // Store previous status for comparison
                const previousStatus = { ...deviceStatus };
                let hasChanges = false;
                
                // Update device status and check for changes
                const newDeviceStatus = {};
                statusData.forEach(device => {
                    newDeviceStatus[device.name] = device.status;
                    if (previousStatus[device.name] !== device.status) {
                        console.log(`Status changed for ${device.name}: ${previousStatus[device.name]} -> ${device.status}`);
                        hasChanges = true;
                    }
                });
                
                // Only update if there are changes
                if (hasChanges || Object.keys(previousStatus).length === 0) {
                    deviceStatus = newDeviceStatus;
                    
                    // Update the equipment list to reflect the new status
                    if (allEquipment.length > 0) {
                        updateEquipmentList(allEquipment);
                        updateDashboardStats(allEquipment);
                        
                        // If we have a selected equipment, update its chart
                        if (currentEquipmentId) {
                            const currentEq = allEquipment.find(eq => eq.id === currentEquipmentId);
                            if (currentEq) {
                                updateChart();
                            }
                        }
                    }
                    
                    // Show notification for status changes
                    showStatusChangeNotification(statusData, previousStatus);
                }
                
                return statusData;
                
            } catch (error) {
                console.error('Error fetching device status:', error);
                updateConnectionStatus(false);
                return [];
            }
        }
        
        // Show notification when device status changes
        function showStatusChangeNotification(currentStatus, previousStatus) {
            // Skip if no previous status (first load)
            if (!previousStatus || Object.keys(previousStatus).length === 0) return;
            
            // Check for status changes and show notifications
            currentStatus.forEach(device => {
                const prevStatus = previousStatus[device.name];
                if (prevStatus && prevStatus !== device.status) {
                    const statusText = device.status === 'online' ? 'en ligne' : 'hors ligne';
                    const statusClass = device.status === 'online' ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500';
                    
                    // Create notification element
                    const notification = document.createElement('div');
                    notification.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg border-l-4 ${statusClass} max-w-sm z-50 transform transition-all duration-300 translate-x-0`;
                    notification.innerHTML = `
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas ${device.status === 'online' ? 'fa-check-circle text-green-600' : 'fa-exclamation-circle text-red-600'}"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium">
                                    ${device.name} est maintenant ${statusText}
                                </h3>
                                <p class="text-sm text-gray-600 mt-1">
                                    ${new Date().toLocaleTimeString()}
                                </p>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    // Add to notifications container or create one
                    let container = document.getElementById('notifications-container');
                    if (!container) {
                        container = document.createElement('div');
                        container.id = 'notifications-container';
                        container.className = 'fixed bottom-4 right-4 space-y-2 z-50';
                        document.body.appendChild(container);
                    }
                    
                    // Add new notification
                    container.insertBefore(notification, container.firstChild);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        notification.style.transform = 'translateX(120%)';
                        setTimeout(() => notification.remove(), 300);
                    }, 5000);
                }
            });
        }

        // Update the equipment list
        function updateEquipmentList(equipment) {
            const container = document.getElementById('equipment-list');
            if (!container) return;
            
            // Store scroll position to restore it after update
            const scrollPosition = container.scrollTop;
            
            container.innerHTML = ''; // Clear existing content
            
            if (!equipment || equipment.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Aucun équipement trouvé</p>';
                updateEquipmentCount(0);
                return;
            }
            
            const selectedLigne = document.getElementById('ligne')?.value || '';
            const selectedAtelier = document.getElementById('atelier')?.value || '';
            
            let visibleCount = 0;
            let hasSelectedItem = false;
            
            // Sort equipment: online first, then by name
            const sortedEquipment = [...equipment].sort((a, b) => {
                const statusA = deviceStatus[a.name] === 'online' ? 0 : 1;
                const statusB = deviceStatus[b.name] === 'online' ? 0 : 1;
                if (statusA !== statusB) return statusA - statusB;
                return (a.name || '').localeCompare(b.name || '');
            });
            
            sortedEquipment.forEach(item => {
                // Skip if filters don't match
                if (selectedLigne && item.ligne !== selectedLigne) return;
                if (selectedAtelier && item.atelier !== selectedAtelier) return;
                
                visibleCount++;
                
                const isOnline = (deviceStatus[item.name] || item.status) === 'online';
                const isSelected = item.id === currentEquipmentId;
                if (isSelected) hasSelectedItem = true;
                
                const equipmentItem = document.createElement('div');
                equipmentItem.className = `equipment-item p-4 hover:bg-gray-50 cursor-pointer border-l-4 ${isOnline ? 'border-green-500' : 'border-red-500'} ${isSelected ? 'bg-blue-50' : ''}`;
                equipmentItem.setAttribute('data-id', item.id);
                equipmentItem.setAttribute('data-ligne', item.ligne || '');
                equipmentItem.setAttribute('data-atelier', item.atelier || '');
                equipmentItem.style.minHeight = '100px'; // Ensure consistent height
                
                const lastChecked = item.last_checked ? new Date(item.last_checked).toLocaleTimeString() : 'Maintenant';
                
                equipmentItem.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <h3 class="text-sm font-medium text-gray-900">${item.name || 'Équipement sans nom'}</h3>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${isOnline ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${isOnline ? 'En ligne' : 'Hors ligne'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">${item.ligne || ''}${item.atelier ? ' - ' + item.atelier : ''}</p>
                            <div class="mt-2 text-xs text-gray-500">
                                <p>Dernière vérification: ${lastChecked}</p>
                                ${item.data_rate ? `<p>Débit: ${item.data_rate.toFixed(2)} Mb/s</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                equipmentItem.addEventListener('click', () => {
                    currentEquipmentId = item.id;
                    updateEquipmentList(equipment); // Re-render to update selection
                    if (dataRateChart) {
                        updateChart();
                    } else {
                        createChart(item);
                    }
                });
                
                container.appendChild(equipmentItem);
            });
            
            // If the selected item is no longer visible, select the first visible one
            if (!hasSelectedItem && visibleCount > 0) {
                const firstItem = container.querySelector('.equipment-item');
                if (firstItem) {
                    currentEquipmentId = parseInt(firstItem.getAttribute('data-id'));
                    firstItem.classList.add('bg-blue-50');
                    if (dataRateChart) {
                        updateChart();
                    }
                }
            }
            
            // Restore scroll position
            container.scrollTop = scrollPosition;
            
            updateEquipmentCount(visibleCount);
        }

        // Update the equipment count display
        function updateEquipmentCount(count) {
            const countElement = document.getElementById('equipment-count');
            if (countElement) {
                countElement.textContent = `${count} équipement${count !== 1 ? 's' : ''}`;
            }
        }
        
        // Update dashboard statistics
        function updateDashboardStats(equipment) {
            if (!equipment || !Array.isArray(equipment)) {
                console.warn('Invalid equipment data:', equipment);
                return { total: 0, online: 0, issues: 0 };
            }
            
            try {
                const selectedLigne = document.getElementById('ligne')?.value || '';
                const selectedAtelier = document.getElementById('atelier')?.value || '';
                
                let filteredEquipment = [...equipment];
                
                // Apply filters
                if (selectedLigne) {
                    filteredEquipment = filteredEquipment.filter(eq => eq.ligne === selectedLigne);
                }
                
                if (selectedAtelier) {
                    filteredEquipment = filteredEquipment.filter(eq => eq.atelier === selectedAtelier);
                }
                
                const total = filteredEquipment.length;
                const online = filteredEquipment.filter(eq => (deviceStatus[eq.name] || eq.status) === 'online').length;
                const issues = total - online;
                
                // Update the stats cards with animation
                const totalElement = document.getElementById('total-equipment');
                const onlineElement = document.getElementById('online-equipment');
                const issuesElement = document.getElementById('issues-equipment');
                
                // Animate the counter
                const animateValue = (element, start, end, duration = 800) => {
                    if (start === end) return;
                    const range = end - start;
                    const startTime = performance.now();
                    
                    const updateCounter = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        const current = Math.floor(start + range * progress);
                        
                        if (element) {
                            element.textContent = current.toLocaleString();
                            
                            // Add/remove pulse effect for changes
                            if (progress < 1) {
                                element.classList.add('animate-pulse');
                                requestAnimationFrame(updateCounter);
                            } else {
                                element.classList.remove('animate-pulse');
                            }
                        }
                    };
                    
                    requestAnimationFrame(updateCounter);
                };
                
                // Update values with animation
                if (totalElement) {
                    const currentTotal = parseInt(totalElement.textContent) || 0;
                    animateValue(totalElement, currentTotal, total);
                }
                
                if (onlineElement) {
                    const currentOnline = parseInt(onlineElement.textContent) || 0;
                    animateValue(onlineElement, currentOnline, online);
                    
                    // Update color based on status
                    const card = onlineElement.closest('.bg-white');
                    if (card) {
                        card.classList.remove('bg-green-50', 'bg-red-50', 'bg-yellow-50');
                        if (online === total) {
                            card.classList.add('bg-green-50');
                        } else if (online === 0) {
                            card.classList.add('bg-red-50');
                        } else {
                            card.classList.add('bg-yellow-50');
                        }
                    }
                }
                
                if (issuesElement) {
                    const currentIssues = parseInt(issuesElement.textContent) || 0;
                    animateValue(issuesElement, currentIssues, issues);
                    
                    // Update color based on status
                    const card = issuesElement.closest('.bg-white');
                    if (card) {
                        card.classList.remove('bg-green-50', 'bg-red-50', 'bg-yellow-50');
                        if (issues === 0) {
                            card.classList.add('bg-green-50');
                        } else if (issues === total) {
                            card.classList.add('bg-red-50');
                        } else {
                            card.classList.add('bg-yellow-50');
                        }
                    }
                }
                
                return { total, online, issues };
                
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
                return { total: 0, online: 0, issues: 0 };
            }
        }
        
        // Update the chart with data for the selected equipment
        async function updateChart() {
            if (!currentEquipmentId) {
                console.warn('No equipment ID selected for chart update');
                return;
            }
            
            console.log(`Updating chart for equipment ID: ${currentEquipmentId}`);
            
            try {
                const response = await fetch(`/api/equipment/${currentEquipmentId}`, {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Chart API Error:', response.status, errorText);
                    throw new Error(`Chart API Error: ${response.status} ${response.statusText}`);
                }
                
                const equipment = await response.json();
                console.log('Chart data received:', equipment);
                
                if (!equipment) {
                    throw new Error('No equipment data received for chart');
                }
                
                if (!dataRateChart) {
                    console.log('Creating new chart');
                    createChart(equipment);
                } else {
                    console.log('Updating existing chart');
                    updateChartData(equipment);
                }
                
                updateConnectionStatus(true);
                return true;
            } catch (error) {
                console.error('Error in updateChart:', error);
                updateConnectionStatus(false);
                return false;
            }
        }

        // Create the initial chart
        function createChart(equipment) {
            const ctx = document.getElementById('dataRateChart').getContext('2d');
            
            dataRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Data Rate (Mbps)',
                        data: [],
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#0ea5e9',
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' Mbps';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        title: {
                            display: true,
                            text: `${equipment.name} - Data Rate`,
                            font: {
                                size: 16
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Update chart with new data
        function updateChartData(equipment) {
            if (!dataRateChart) return;
            
            // Update chart title
            dataRateChart.options.plugins.title.text = `${equipment.name} - Data Rate`;
            
            // Add new data point
            const now = new Date().toLocaleTimeString();
            
            if (dataRateChart.data.labels.length >= 15) {
                dataRateChart.data.labels.shift();
                dataRateChart.data.datasets[0].data.shift();
            }
            
            dataRateChart.data.labels.push(now);
            dataRateChart.data.datasets[0].data.push(equipment.data_rate);
            
            // Update the chart
            dataRateChart.update();
        }
    </script>
</body>
</html>
